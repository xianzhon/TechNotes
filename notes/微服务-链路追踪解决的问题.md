## 1. 链路追踪 - distributed tracing

### 1.1. **链路追踪解决的问题**

在微服务架构中，用户的请求通常会经历多个服务调用。例如，用户下单时，会依次调用**订单服务**、**库存服务**、**优惠券服务**、**支付服务**等。链路追踪（Distributed Tracing）的核心作用是**追踪请求的完整流转路径**，帮助开发者理解请求在分布式系统中的行为，并解决以下问题：

#### 1.1.1. **请求流转不透明**
- **问题**：传统日志分散在各个服务中，无法直观看到请求的完整调用链。
- **解决**：通过**Trace ID**串联所有相关服务调用，形成可视化的调用拓扑图。

#### 1.1.2. **性能瓶颈难定位**
- **问题**：请求变慢时，无法快速确定是哪个服务或数据库查询导致的延迟。
- **解决**：记录每个**Span**（服务调用单元）的耗时，生成火焰图，直观展示耗时最长的环节。

#### 1.1.3. **故障排查困难**
- **问题**：跨服务调用失败时（如库存扣减失败导致下单失败），难以追踪根因。
- **解决**：通过Trace ID关联所有服务的错误日志，快速定位异常节点（如支付服务超时）。

#### 1.1.4. **依赖关系不清晰**
- **问题**：服务间依赖复杂（如订单服务依赖库存、优惠券、风控服务），人工维护依赖文档成本高。
- **解决**：自动生成服务依赖拓扑，识别冗余调用或循环依赖。

#### 1.1.5. **分布式事务监控**
- **问题**：分布式事务（如Saga模式）涉及多个服务，难以保证最终一致性。
- **解决**：追踪事务分支的执行状态，辅助排查事务中断或补偿失败的问题。

---

### 1.2. **链路追踪的核心价值**

- **快速定位问题**：例如，用户下单失败，通过Trace ID发现是支付服务超时，而非库存问题。
- **优化系统性能**：识别慢调用（如数据库查询耗时），针对性优化代码或扩容实例。
- **降低运维复杂度**：统一聚合跨服务的日志、指标，避免“盲人摸象”式排查。
- **保障SLA（服务等级协议）**：监控关键路径的耗时（如“下单→支付”链路的99分位延迟），确保用户体验。

---

### 1.3. **典型链路追踪流程（以用户下单为例）**

1. **请求入口**：用户发起下单请求，网关生成全局**Trace ID**（如`ABC123`）。
2. **订单服务**：记录Span（如`create_order`耗时50ms），调用库存服务时传递Trace ID。
3. **库存服务**：扣减库存，记录Span（如`deduct_inventory`耗时30ms）。
4. **支付服务**：处理支付，记录Span（如`process_payment`耗时100ms）。
5. **结果汇总**：所有Span上报至追踪系统（如Jaeger），还原完整调用链。

---

### 1.4. **常见工具对比**

| 工具          | 特点                                                                 |
|---------------|----------------------------------------------------------------------|
| **Zipkin**    | 轻量级，支持多种语言，依赖Elasticsearch存储数据。                    |
| **Jaeger**    | Uber开源，支持分布式上下文传播、自适应采样，可视化强大。             |
| **SkyWalking**| 国产开源，集成Metrics/Logging/Tracing，适合云原生。                  |
| **AWS X-Ray** | 云服务集成，自动分析服务拓扑和延迟瓶颈。                             |

---

### 1.5. **实际应用场景**

- **场景1**：用户投诉“下单慢”
  **分析**：通过链路追踪发现库存服务的数据库查询占用了80%的请求时间，优化SQL后延迟下降60%。

- **场景2**：订单支付失败率突然升高
  **排查**：追踪显示支付服务调用第三方API超时，联系服务商修复后恢复。

---

### 1.6. **总结**

链路追踪通过**唯一Trace ID串联跨服务调用**，解决了微服务环境下请求流转不透明、故障难定位、性能难优化等痛点，是分布式系统可观测性（Observability）的关键支柱。结合日志（Logging）和指标（Metrics），可构建完整的监控体系。